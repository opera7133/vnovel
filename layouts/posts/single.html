{{ define "meta_tags" }}

<meta property="og:site_name" content="{{ .Site.Title }}" />
<meta property="og:title" content="{{ .Title }} - {{ .Site.Title }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{ .Permalink }}" />
<meta property="og:locale" content="ja_JP" />
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="{{ .Title }}">

{{ if .Params.image }}
{{ with .Params.image }}
<meta property="og:image" content="{{ . | absURL }}">
<meta property="og:image:url" content="{{ . | absURL }}">
{{ end }}
{{ else }}
<meta property="og:image" content="{{ .Site.Params.homepage_meta_tags.meta_og_image | absURL }}">
<meta property="og:image:url" content="{{ .Site.Params.homepage_meta_tags.meta_og_image | absURL }}">
{{ end }}

{{- if .Description }}
<meta property="og:description" content="{{ substr .Description 0 130 | plainify }}" />
<meta property="twitter:description" content="{{ substr .Description 0 130 | plainify }}" />
{{- else if .Summary }}
<meta property="og:description" content="{{ substr .Summary 0 130 | plainify }}" />
<meta property="twitter:description" content="{{ substr .Summary 0 130 | plainify }}" />
{{- else if .Site.Params.description }}
<meta property="og:description" content="{{ substr .Site.Params.description 0 130 | plainify }}" />
<meta property="twitter:description" content="{{ substr .Site.Params.description 0 130 | plainify }}" />
{{- end }}
{{ end }}

{{ define "main" }}
<main class="container mx-auto max-w-7xl flex flex-col-reverse lg:flex-row my-4">
  <div class="w-full lg:w-3/4 bg-white dark:bg-neutral-800 rounded-xl dark:text-white">
    <article class="rounded-t-2xl" id="novel-main">
      <div class="lg:flex p-7 bg-white dark:bg-neutral-800 rounded-t-xl text-black dark:text-white">
        {{ if .Params.image }}
        <img class="rounded mx-auto w-auto h-48 lg:ml-0 lg:mr-8" src="{{ .Params.image | relURL }}" alt="thumbnail"/>
        {{ else }}
        <img class="rounded mx-auto w-auto h-48 lg:ml-0 lg:mr-8" src="{{ "/img/novel.svg" | relURL }}" alt="thumbnail"/>
        {{ end }}
        <div>
          <h1 class="title text-2xl my-3 font-bold">{{ .Title }}</h1>
          <p class="mb-3 text-xs opacity-70">
            {{ .Content | countwords }} {{ i18n "words" }}
            ({{ if eq .Site.Language.Lang "ja" }}読了目安: {{ end }}{{ math.Round (div (countwords .Content) 220.0) }}{{ i18n "minutes" }})
          </p>
          <p class="mb-2 text-sm opacity-80">{{ replaceRE "(https?://[a-zA-Z0-9\\-._~:/?#\\[\\]@!\\$&'()*\\+,;%=]+)" "<a href=\"$1\" class=\"text-cyan-600 opacity-100 hover:text-cyan-700 focus:text-cyan-700\">$1</a>" .Description | safeHTML }}</p>
          <div id="tags" class="flex gap-2 mb-2">
            {{ $r18tags := slice "r18" "R18" "r-18" "R-18" }}
            {{ $r15tags := slice "r15" "R15" "r-15" "R-15" }}
            {{ $matchedR18 := intersect .Params.tags $r18tags }}
            {{ $matchedR15 := intersect .Params.tags $r15tags }}

            {{ if gt (len $matchedR18) 0 }}
            {{ $tagName := index $matchedR18 0 }}
            <span class="text-sm inline-flex leading-4 content-center justify-center text-rose-600 font-semibold">
              <a href="{{ "tags" | absURL}}/{{ $tagName | urlize }}">R-18</a>
            </span>
            {{ else if gt (len $matchedR15) 0 }}
            {{ $tagName := index $matchedR15 0 }}
            <span class="text-sm inline-flex leading-4 content-center justify-center text-orange-500 font-semibold">
              <a href="{{ "tags" | absURL}}/{{ $tagName | urlize }}">R-15</a>
            </span>
            {{ end }}
            {{ with .Params.tags }}
            {{ range . }}
            {{ if and (not (in $r18tags .)) (not (in $r15tags .)) }}
            <span class="text-sm inline-flex leading-4 content-center justify-center text-cyan-600">
              <a href="{{ "tags" | absURL}}/{{ . | urlize }}">#{{ . }}</a>
            </span>
            {{ end }}
            {{ end }}
            {{ end }}
          </div>
          <time id="date" class="text-xs text-neutral-500 dark:text-neutral-300">{{ .Date.Format "2006/01/02 15:04" }}</time>
        </div>
      </div>
      <div class="border-y border-neutral-200 reader-dark:border-neutral-700">
        <div class="block py-10" id="content-bg">
          <div class="mx-auto max-w-2xl">
            <div class="prose prose-sm lg:prose-base max-w-none reader-dark:prose-invert py-3 px-5" id="article-content">
              {{ .Content | replaceRE "\\[newpage\\]" "<span class=\"newpage-marker\"></span>" | safeHTML }}
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white/80 reader-dark:bg-neutral-800/80 px-4 sticky bottom-0 z-40" id="sticky-nav">
        <div id="article-pagination" class="flex justify-center flex-wrap gap-1"></div>
        <div class="mx-auto max-w-2xl flex flex-row justify-between items-center">
          {{ partial "settings_panel.html" . }}
          {{ partial "sns_share.html" . }}
        </div>
      </div>
    </article>
    <div class="pb-8"></div>
    <div class="p-7 rounded-b-xl">
      <div class="mx-auto max-w-2xl">
        {{ partial "comments.html" . }}
      </div>
    </div>
  </div>
  <div class="mt-8 lg:ml-5 lg:w-1/4 block">
    {{ with .Params.authors }}
    <div class="px-4 dark:text-white font-bold mb-7">
      {{ range . }}
      {{ $authorName := . }}
      {{ $authorPage := site.GetPage (printf "/authors/%s" $authorName) }}
      <a href="{{ "authors" | absURL }}/{{ . | urlize }}" class="hover:underline flex mb-3">
        <div>
          {{ if and $authorPage $authorPage.Params.avatar }}
          <img src="{{ $authorPage.Params.avatar | relURL }}" class="w-11 rounded-full" />
          {{ else if $.Params.avatar }}
          <img src="{{ $.Params.avatar | relURL }}" class="w-11 rounded-full" />
          {{ else }}
          <img src="/img/avatar.svg" class="w-11 rounded-full" />
          {{ end }}
        </div>
        <p class="mt-2 ml-2">{{ . }}</p>
      </a>
      {{ end }}
    </div>
    {{ end }}
    <div>
      {{ $hasAuthorRelated := false }}
      {{ if .Params.authors }}
        {{ $author := index .Params.authors 0 }}
        {{ $authorKey := lower $author }}

        {{ with index site.Taxonomies.authors $authorKey }}
          {{ $authorPosts := .Pages.ByDate }}
          {{ $currentPermalink := $.Permalink }}
          {{ $prev := "" }}
          {{ $next := "" }}

          {{ range $index, $element := $authorPosts }}
            {{ if eq .Permalink $currentPermalink }}
              {{ if gt $index 0 }}
                {{ $prev = index $authorPosts (sub $index 1) }}
              {{ end }}
              {{ if lt $index (sub (len $authorPosts) 1) }}
                {{ $next = index $authorPosts (add $index 1) }}
              {{ end }}
            {{ end }}
          {{ end }}

          {{ if or $prev $next }}
            {{ $hasAuthorRelated = true }}
            <div class="rounded-xl panel mb-3 pb-5 text-sm">
              <div class="mx-4 text-gray-700 dark:text-white mb-1 flex justify-between">
                <p class="font-bold">{{ i18n "previous_next" }}</p>
                <a href="{{ "authors" | absURL }}/{{ $author | urlize }}" class="hover:underline">
                  {{ i18n "see_all" }}
                </a>
              </div>
              <div class="mx-4 grid grid-cols-1 gap-1 font-bold">
                {{ with $prev }}
                <a href="{{ .RelPermalink }}" class="">
                  <div class="px-2 py-1 rounded w-full block dark:hover:bg-neutral-800 hover:bg-gray-200 duration-200">
                    <div class="text-gray-900 dark:text-gray-100">{{.Title}}</div>
                  </div>
                </a>
                {{ end }}
                {{ with $next }}
                <a href="{{ .RelPermalink }}" class="">
                  <div class="px-2 py-1 rounded w-full block dark:hover:bg-neutral-800 hover:bg-gray-200 duration-200">
                    <div class="text-gray-900 dark:text-gray-100">{{.Title}}</div>
                  </div>
                </a>
                {{ end }}
              </div>
            </div>
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if not $hasAuthorRelated }}
        {{ $filteredPosts := where .Site.RegularPages "Type" "in" site.Params.mainSections }}
        {{ $relatedPosts := shuffle $filteredPosts | first 5 }}
        {{- if $relatedPosts }}
        <div class="rounded-xl panel mb-3 pb-5 font-bold">
          <p class="mx-4 text-base text-gray-700 dark:text-white">{{ i18n "others" }}</p>
          <div class="mx-4">
            {{ range $relatedPosts }}
            <a href="{{ .RelPermalink }}" class="">
              <div class="px-2 py-1 rounded w-full block dark:hover:bg-neutral-800 hover:bg-gray-200 duration-200">
                <div class="text-gray-900 dark:text-gray-100 text-base">{{.Title}}</div>
              </div>
            </a>
            {{- end }}
          </div>
        </div>
        {{- end }}
      {{ end }}
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const content = document.getElementById('article-content');
      if (!content) return;

      const applyRuby = (root) => {
        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
        const nodes = [];
        while (walker.nextNode()) {
          const node = walker.currentNode;
          const parentName = node.parentNode.nodeName.toLowerCase();
          if (!['code', 'pre', 'textarea', 'script', 'style', 'kbd', 'samp', 'var'].includes(parentName)) {
            nodes.push(node);
          }
        }

        nodes.forEach(node => {
          const text = node.nodeValue;
          const regex = /(\\)?\{([^}\n]*\|[^}\n]*)\}/g;

          if (!regex.test(text)) return;
          regex.lastIndex = 0;

          const fragment = document.createDocumentFragment();
          let lastIndex = 0;
          let match;

          while ((match = regex.exec(text)) !== null) {
            fragment.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
            console.log(match)
            const isEscaped = match[1] === '\\';
            const content = match[2];

            if (isEscaped || content.includes("\\|") || content.startsWith("|")) {
              fragment.appendChild(document.createTextNode(`{${content.replace("\\|","|")}}`));
            } else {
              const parts = content.split('|');
              const base = parts[0];
              const readings = parts.slice(1);

              const ruby = document.createElement('ruby');

              if (readings.length > 1 && base.length === readings.length) {
                for (let i = 0; i < base.length; i++) {
                  ruby.appendChild(document.createTextNode(base[i]));
                  const rt = document.createElement('rt');
                  rt.textContent = readings[i];
                  ruby.appendChild(rt);
                }
              } else {
                ruby.appendChild(document.createTextNode(base));
                const rt = document.createElement('rt');
                rt.textContent = readings.join('');
                ruby.appendChild(rt);
              }
              fragment.appendChild(ruby);
            }

            lastIndex = regex.lastIndex;
          }

          fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
          node.parentNode.replaceChild(fragment, node);
        });
      };

      applyRuby(content);

      const markerClass = 'newpage-marker';
      if (!content.querySelector('.' + markerClass)) return;

      const children = Array.from(content.children);
      const pages = [];
      let currentPage = [];

      children.forEach(child => {
        const hasMarker = child.querySelector('.' + markerClass) || child.classList.contains(markerClass);
        if (hasMarker) {
          if (currentPage.length > 0) {
            pages.push(currentPage);
            currentPage = [];
          }
        } else {
          currentPage.push(child);
        }
      });

      if (currentPage.length > 0) {
        pages.push(currentPage);
      }

      if (pages.length <= 1) return;

      content.innerHTML = '';

      const createNavButton = (text, onClick, reverse = false) => {
        const btn = document.createElement('button');
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${reverse ? "M9 5l7 7-7 7" : "M15 19l-7-7 7-7"}" /></svg><p>${text}</p>`;
        btn.className = 'w-full py-16 cursor-pointer bg-transparent hover:bg-gray-100 reader-dark:bg-[#262626] reader-dark:hover:bg-[#404040] text-base transition-colors text-gray-500 reader-dark:text-gray-400 flex flex-col justify-center items-center';
        btn.onclick = onClick;
        return btn;
      };


      pages.forEach((pageNodes, index) => {
        const pageDiv = document.createElement('div');
        pageDiv.id = `page-${index + 1}`;
        pageDiv.classList.add('article-page');
        if (index !== 0) {
            pageDiv.style.display = 'none';
        }

        pageNodes.forEach(node => pageDiv.appendChild(node));
        content.appendChild(pageDiv);
      });

      // Containers for external nav buttons
      const contentBg = document.getElementById('content-bg');
      const topNavContainer = document.createElement('div');
      topNavContainer.id = 'top-nav-container';
      contentBg.parentNode.insertBefore(topNavContainer, contentBg);

      const bottomNavContainer = document.createElement('div');
      bottomNavContainer.id = 'bottom-nav-container';
      contentBg.parentNode.insertBefore(bottomNavContainer, contentBg.nextSibling);

      const updateNavButtons = (index) => {
        topNavContainer.innerHTML = '';
        bottomNavContainer.innerHTML = '';

        // Prev Button (Top)
        if (index > 0) {
          topNavContainer.appendChild(createNavButton('{{ i18n "prev_page" | default "前のページ" }}', () => goToPage(index)));
        }

        // Next Button (Bottom)
        if (index < pages.length - 1) {
            bottomNavContainer.appendChild(createNavButton('{{ i18n "next_page" | default "次のページ" }}', () => goToPage(index + 2), true));
        }
      };

      const params = new URLSearchParams(window.location.search);
      let initialPage = parseInt(params.get('page')) || 1;

      const renderPagination = (current, total) => {
        const container = document.getElementById('article-pagination');
        if (!container) return;
        container.innerHTML = '';

        // Prev button
        const prevBtn = document.createElement('button');
        prevBtn.className = `my-2 w-10 h-10 rounded-full flex items-center justify-center transition-colors ${
          current > 1
            ? 'cursor-pointer text-gray-700 hover:bg-gray-100 reader-dark:text-gray-300 reader-dark:hover:bg-neutral-700'
            : 'opacity-0'
        }`;
        prevBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>';
        prevBtn.onclick = () => {
          if (current > 1) goToPage(current - 1);
        };
        container.appendChild(prevBtn);

        // Page numbers
        for (let i = 1; i <= total; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          const isActive = i === current;
          btn.className = `my-2 font-semibold cursor-pointer w-10 h-10 rounded-full transition-colors hidden sm:block ${
            isActive
              ? 'bg-black text-white reader-dark:bg-neutral-700'
              : 'bg-transparent text-gray-700 hover:bg-gray-100 reader-dark:text-gray-300 reader-dark:hover:bg-neutral-700'
          }`;
          btn.onclick = () => goToPage(i);
          container.appendChild(btn);
        }

        // Mobile current page indicator if numbers are hidden
        const mobileIndicator = document.createElement('span');
        mobileIndicator.className = 'my-2 sm:hidden flex items-center justify-center h-10 px-2 font-medium text-gray-700 reader-dark:text-gray-300';
        mobileIndicator.textContent = `${current} / ${total}`;
        container.appendChild(mobileIndicator);

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = `my-2 w-10 h-10 rounded-full flex items-center justify-center transition-colors ${
          current < total
            ? 'cursor-pointer text-gray-700 hover:bg-gray-100 reader-dark:text-gray-300 reader-dark:hover:bg-neutral-700'
            : 'opacity-0'
        }`;
        nextBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>';
        nextBtn.onclick = () => {
          if (current < total) goToPage(current + 1);
        };
        container.appendChild(nextBtn);
      };

      const goToPage = (n) => {
        if (n < 1 || n > pages.length) return;

        document.querySelectorAll('.article-page').forEach(el => el.style.display = 'none');
        const target = document.getElementById(`page-${n}`);
        if (target) {
          target.style.display = 'block';

          const url = new URL(window.location);
          url.searchParams.set('page', n);
          window.history.pushState({}, '', url);

          renderPagination(n, pages.length);
          updateNavButtons(n - 1); // index is 0-based

          const bg = document.getElementById('content-bg');
          if (bg) {
            const top = bg.offsetTop;
            window.scrollTo({ top: top - 20, behavior: 'smooth' });
          }
        }
      };

      renderPagination(initialPage, pages.length);
      if (initialPage !== 1) goToPage(initialPage);
      updateNavButtons(initialPage - 1);
    });
  </script>
</main>
{{ end }}

