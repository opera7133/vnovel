{{ define "main" }}
<main class="container mx-auto max-w-7xl my-4">
  <h1 class="text-2xl mt-3 mb-6 pl-6 font-bold dark:text-white">{{.Title}}</h1>
  <div class="bg-white dark:bg-neutral-800 rounded-xl mx-3 mb-16 px-2 dark:text-white relative">
    <div class="p-8 lg:px-20 pb-28 prose prose-sm max-w-none lg:prose-lg dark:prose-invert">
      <div class="mb-6" id="article-content">{{ .Content | replaceRE "\\[newpage\\]" "<span class=\"newpage-marker\"></span>" | replaceRE "\\{([^|]+)\\|([^}]+)\\}" "<ruby>$1<rt>$2</rt></ruby>" | safeHTML }}</div>

      {{ with .Params.authors }}
      <div class="mt-8 border-t border-neutral-200 dark:border-neutral-700 pt-8">
        {{ range . }}
        {{ $authorName := . }}
        {{ $authorPage := site.GetPage (printf "/authors/%s" ($authorName | urlize)) }}
        {{ if $authorPage }}
        <div class="mb-6 flex items-start gap-4">
          {{ if $authorPage.Params.avatar }}
          <a href="{{ $authorPage.RelPermalink }}" class="shrink-0">
            <img src="{{ $authorPage.Params.avatar | relURL }}" alt="{{ $authorName }}" class="w-16 h-16 rounded-full object-cover border-2 border-white dark:border-neutral-600">
          </a>
          {{ end }}
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold dark:text-white">
                <a href="{{ $authorPage.RelPermalink }}" class="hover:underline">{{ $authorName }}</a>
              </h3>
              <div class="flex gap-2">
                {{ with $authorPage.Params.social }}
                {{ with .twitter }}<a href="{{ . }}" target="_blank" rel="noopener noreferrer" class="text-neutral-400 hover:text-cyan-600">
                  <svg fill="currentColor" class="h-5 w-5" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                </a>{{ end }}
                {{ with .website }}<a href="{{ . }}" target="_blank" rel="noopener noreferrer" class="text-neutral-400 hover:text-cyan-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                </a>{{ end }}
                {{ end }}
              </div>
            </div>
            <div class="text-sm text-neutral-600 dark:text-neutral-300 mt-1">
              {{ $authorPage.Content | truncate 200 }}
            </div>
          </div>
        </div>
        {{ end }}
        {{ end }}
      </div>
      {{ end }}

      {{ partial "comments.html" . }}
    </div>

  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const content = document.getElementById('article-content');
      if (!content) return;

      const markerClass = 'newpage-marker';
      if (!content.querySelector('.' + markerClass)) return;

      const children = Array.from(content.children);
      const pages = [];
      let currentPage = [];

      children.forEach(child => {
        const hasMarker = child.querySelector('.' + markerClass) || child.classList.contains(markerClass);
        if (hasMarker) {
          if (currentPage.length > 0) {
            pages.push(currentPage);
            currentPage = [];
          }
        } else {
          currentPage.push(child);
        }
      });

      if (currentPage.length > 0) {
        pages.push(currentPage);
      }

      if (pages.length <= 1) return;

      content.innerHTML = '';

      pages.forEach((pageNodes, index) => {
        const pageDiv = document.createElement('div');
        pageDiv.id = `page-${index + 1}`;
        pageDiv.classList.add('article-page');
        if (index !== 0) pageDiv.style.display = 'none';

        pageNodes.forEach(node => pageDiv.appendChild(node));
        content.appendChild(pageDiv);
      });

      const paginationContainer = document.createElement('div');
      paginationContainer.id = 'article-pagination';
      paginationContainer.className = 'flex justify-center flex-wrap gap-2 mt-8';
      content.after(paginationContainer);

      const params = new URLSearchParams(window.location.search);
      let initialPage = parseInt(params.get('page')) || 1;

      const renderPagination = (current, total) => {
        const container = document.getElementById('article-pagination');
        container.innerHTML = '';

        for (let i = 1; i <= total; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          const isActive = i === current;
          btn.className = `px-4 py-2 rounded-lg border transition-colors ${
            isActive
              ? 'bg-cyan-600 text-white border-cyan-600'
              : 'bg-white dark:bg-neutral-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-neutral-600 hover:bg-gray-100 dark:hover:bg-neutral-700'
          }`;
          btn.onclick = () => goToPage(i);
          container.appendChild(btn);
        }
      };

      const goToPage = (n) => {
        if (n < 1 || n > pages.length) return;

        document.querySelectorAll('.article-page').forEach(el => el.style.display = 'none');
        const target = document.getElementById(`page-${n}`);
        if (target) {
          target.style.display = 'block';

          const url = new URL(window.location);
          url.searchParams.set('page', n);
          window.history.pushState({}, '', url);

          renderPagination(n, pages.length);

          const bg = document.querySelector('.bg-white.dark\\:bg-neutral-800.rounded-xl') || document.querySelector('main');
          if (bg) {
            const top = bg.offsetTop;
            window.scrollTo({ top: top - 20, behavior: 'smooth' });
          }
        }
      };

      renderPagination(initialPage, pages.length);
      if (initialPage !== 1) goToPage(initialPage);
    });
  </script>
</main>
{{ end }}
