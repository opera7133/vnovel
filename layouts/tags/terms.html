{{ define "main" }}
<main class="container mx-auto max-w-7xl px-4 my-4">
  <div class="flex flex-col md:flex-row justify-between items-start py-6 gap-4">
    <h2 class="text-4xl font-bold dark:text-white">#{{ .Title }}</h2>

    <!-- Controls -->
    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
      <!-- Search -->
      <div class="relative">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
        </div>
        <input type="text" id="tag-search" onkeyup="filterTags()"
            class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-neutral-700 dark:border-neutral-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            placeholder="{{ i18n "search" }}">
      </div>

      <!-- Sort Buttons -->
      <div class="flex rounded-md shadow-sm" role="group">
        <button type="button" onclick="sortTags('name')" id="btn-sort-name"
            class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-neutral-700 dark:border-neutral-600 dark:text-white dark:hover:text-white dark:hover:bg-neutral-600 dark:focus:ring-blue-500 dark:focus:text-white">
          {{ i18n "sort_name" }}
        </button>
        <button type="button" onclick="sortTags('count')" id="btn-sort-count"
            class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-l-0 border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-neutral-700 dark:border-neutral-600 dark:text-white dark:hover:text-white dark:hover:bg-neutral-600 dark:focus:ring-blue-500 dark:focus:text-white">
          {{ i18n "sort_count" }}
        </button>
      </div>
    </div>
  </div>

  <div id="tag-container" class="flex flex-wrap gap-4">
    {{ range $name, $taxonomy := .Site.Taxonomies.tags }}
    <a href="/tags/{{ $name | urlize }}" class="group tag-item" data-name="{{ $name }}" data-count="{{ $taxonomy.Count }}">
      <div class="px-4 py-2 bg-gray-100 dark:bg-neutral-700 rounded-full hover:bg-blue-500 dark:hover:bg-blue-600 transition-colors duration-200 flex items-center shadow-sm">
        {{ $r18tags := slice "r18" "R18" "r-18" "R-18" }}
        {{ $r15tags := slice "r15" "R15" "r-15" "R-15" }}
        <span class="text-lg font-medium
        {{ if gt (len (intersect (slice $name) $r18tags)) 0 }}text-rose-600
        {{ else if gt (len (intersect (slice $name) $r15tags)) 0 }}text-orange-500
        {{ else }}text-gray-700 dark:text-gray-200{{ end }} group-hover:text-white mr-2">#{{ $name }}</span>
        <span class="bg-white dark:bg-neutral-600 text-xs px-2 py-0.5 rounded-full text-gray-500 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-blue-400 font-bold">
          {{ $taxonomy.Count }}
        </span>
      </div>
    </a>
    {{ end }}
  </div>

  <div id="no-results" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
    No tags found.
  </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initial sort by count descending
        sortTags('count');
    });

    function filterTags() {
        const input = document.getElementById('tag-search');
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName('tag-item');
        let visibleCount = 0;

        for (let i = 0; i < items.length; i++) {
            const name = items[i].getAttribute('data-name').toLowerCase();
            if (name.includes(filter)) {
                items[i].style.display = "";
                visibleCount++;
            } else {
                items[i].style.display = "none";
            }
        }

        const noResults = document.getElementById('no-results');
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    function sortTags(type) {
        const container = document.getElementById('tag-container');
        const items = Array.from(document.getElementsByClassName('tag-item'));

        // Update button states
        const btnName = document.getElementById('btn-sort-name');
        const btnCount = document.getElementById('btn-sort-count');

        if (type === 'name') {
            btnName.classList.add('bg-gray-100', 'text-blue-700', 'dark:bg-neutral-600', 'dark:text-white');
            btnName.classList.remove('bg-white', 'text-gray-900', 'dark:bg-neutral-700');
            btnCount.classList.remove('bg-gray-100', 'text-blue-700', 'dark:bg-neutral-600', 'dark:text-white');
            btnCount.classList.add('bg-white', 'text-gray-900', 'dark:bg-neutral-700');
        } else {
            btnCount.classList.add('bg-gray-100', 'text-blue-700', 'dark:bg-neutral-600', 'dark:text-white');
            btnCount.classList.remove('bg-white', 'text-gray-900', 'dark:bg-neutral-700');
            btnName.classList.remove('bg-gray-100', 'text-blue-700', 'dark:bg-neutral-600', 'dark:text-white');
            btnName.classList.add('bg-white', 'text-gray-900', 'dark:bg-neutral-700');
        }

        items.sort((a, b) => {
            const nameA = a.getAttribute('data-name').toLowerCase();
            const nameB = b.getAttribute('data-name').toLowerCase();
            const countA = parseInt(a.getAttribute('data-count'));
            const countB = parseInt(b.getAttribute('data-count'));

            if (type === 'name') {
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            } else {
                // Count descending, if equal then name ascending
                if (countB !== countA) {
                    return countB - countA;
                }
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            }
        });

        items.forEach(item => container.appendChild(item));
    }
</script>
{{ end }}
